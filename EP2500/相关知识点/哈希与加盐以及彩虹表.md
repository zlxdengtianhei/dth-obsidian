## 哈希与加盐
**核心问题：** 当你在一个网站注册时，输入了密码 "MyP@ssword123"。如果网站直接把 "MyP@ssword123" 这串字符存进数据库，会发生什么？

这被称为 **明文存储（Plaintext Storage）**，是**极其危险**的做法。如果黑客攻击并窃取了这个网站的数据库，他们将直接获得所有用户的账户和密码，后果不堪设想。

为了解决这个问题，现代系统采用了一种叫做 **哈希（Hashing）** 的技术。

#### 1. 什么是哈希（Hashing）？

你可以把哈希函数想象成一个神奇的、单向的“绞肉机”。

- **输入任意，输出固定**：无论你输入多长或多短的内容（一个字、一篇文章、一个文件），哈希函数都会输出一个固定长度的字符串。例如，使用 SHA-256 算法，无论输入是 "a" 还是整本《三国演义》，输出都是一个 256 位（通常表示为 64 个十六进制字符）的字符串。
    
- **单向性（不可逆性）**：这是密码安全的核心。你可以从原始数据（密码）轻松计算出哈希值，但**绝对不能**从哈希值反向推导出原始数据。这是数学上的“陷门函数”思想，进去容易，出来难。
    
- **确定性**：只要输入的数据完全相同，无论何时何地，使用同一个哈希函数计算出的哈希值永远是相同的。这是验证密码的基础：服务器只需比较两次哈希值是否一致即可。
    
- **雪崩效应（Avalanche Effect）**：输入的任何微小变化（哪怕只是改变一个字母的大小写）都会导致输出的哈希值发生天翻地覆、完全不同的变化。这确保了相似的密码（如 "password123" 和 "password124"）会产生截然不同的哈希值。


**工作流程：**

1. **注册时：** 你输入密码 "MyP@ssword123"。服务器计算它的哈希值，例如得到 `a1b2c3d4...`，然后只在数据库里存储这个哈希值 `a1b2c3d4...`。服务器**从不保存**你的原始密码 "MyP@ssword123"。
2. **登录时：** 你再次输入密码 "MyP@ssword123"。服务器再次对你输入的密码进行同样的哈希计算，得到一个新的哈希值。然后，它用这个新哈希值去和数据库里存储的哈希值进行比较。
    - 如果两个哈希值**完全一致**，服务器就知道你输入了正确的密码，认证通过！
    - 如果**不一致**，就说明密码错误。

> **这就是“AS 只需要验证认证方知道密码即可，但 AS 不需要知道实际密码”这句话的精确解释。** 服务器通过比较哈希值，间接地验证了你拥有正确的密码，而它自己全程都不知道你的密码原文是什么。

### 第四部分：什么是彩虹表（Rainbow Table）？

彩虹表是针对**未加盐哈希**的一种高效的破解工具。

**核心思想：**  
与其在攻击时才去一个一个地计算密码的哈希值（这叫暴力破解），不如提前把大量常用密码的哈希值都计算好，存成一个巨大的“查询字典”。这个字典就是 **哈希 -> 密码** 的映射表。

**攻击过程：**

1. **准备阶段：** 黑客花费大量时间和计算资源，生成一个彩虹表。例如，他们会计算：
    
    - `hash("123456")` -> `8d969e...`
    - `hash("password")` -> `5e8848...`
    - `hash("qwerty")` -> `65e84be...`
    - ... 包含数百万、数十亿的常用密码组合。
2. **攻击阶段：**
    
    - 黑客成功入侵某网站，窃取了用户数据库。
    - 数据库里存的是未加盐的哈希值，比如黑客看到了用户 Bob 的哈希是 `8d969e...`。
    - 黑客不去尝试破解，而是直接拿着 `8d969e...` 去他的彩虹表里**查询**。
    - 彩虹表立即告诉他，这个哈希值对应的原始密码是 "123456"。
    - 黑客瞬间就破解了 Bob 的密码，整个过程可能不到一秒。

**为什么叫“彩虹”表？**  
这个名字来源于其内部的一种技术优化。一个简单的查询表会非常巨大，而彩虹表使用一种叫做“哈希链”和“归约函数”的数学技巧，可以用更小的空间存储更多的哈希-密码对，大大提高了效率。这个链的结构和颜色变换让人联想到了彩虹，故此得名。你无需深入理解其数学原理，只需记住它是一种**空间换时间**的、针对哈希的快速查找表。

**“加盐”如何彻底摧毁彩虹表？**

这就是“盐”的威力所在。

- 假设 Alice 和 Bob 的密码都是 "123456"。
- 服务器为 Alice 生成了盐 `salt_A`，存储的哈希是 `hash("123456" + salt_A)`。
- 服务器为 Bob 生成了盐 `salt_B`，存储的哈希是 `hash("123456" + salt_B)`。
- 这两个哈希值是**完全不同**的。

现在，黑客的彩虹表（只包含 `hash("123456")` 的结果）完全没用了。为了破解，黑客必须为**每一个可能的盐**都单独生成一个彩虹表，这在计算上是绝对不可行的。他们只能退回到最原始、最慢的暴力破解方式：拿到用户的盐，然后一个一个地去猜密码，这正是慢哈希算法所要防御的。
#### 2. 哈希还不够？引入“盐”（Salting）

单纯的哈希虽然好，但还存在一个问题：**彩虹表攻击（Rainbow Table Attack）**。

黑客们可以提前计算好常用密码（如 "123456", "password"）的哈希值，并存成一个巨大的查询表（彩虹表）。当他们偷到数据库后，只需拿着数据库里的哈希值去查表，就能快速反查出那些使用简单密码的用户的原始密码。

为了对抗这种攻击，我们引入了 **加盐（Salting）** 技术。

- **什么是“盐”（Salt）？** “盐”是一个为每个用户随机生成的、独一无二的字符串。它就像菜里的盐，虽然不是主料，但能彻底改变菜的风味。

**加盐后的工作流程：**

1. **注册时：**
    
    - 用户 "Alice" 输入密码 "123456"。
    - 服务器为 Alice 生成一个随机的、独一无二的盐，比如 `xyz789`。
    - 服务器将密码和盐拼接起来（"123456" + "xyz789"），然后对这个新字符串进行哈希计算。
    - 最终，服务器在数据库中存储 **哈希值** 和 **盐 `xyz789`**。（盐是公开的，存储它没有风险）。
2. **登录时：**
    
    - Alice 输入密码 "123456"。
    - 服务器从数据库中取出 Alice 对应的盐 `xyz789`。
    - 服务器将用户输入的密码和取出的盐拼接（"123456" + "xyz789"），然后进行哈希计算。
    - 将计算出的新哈希值与数据库中存储的哈希值进行比较，如果一致，则登录成功。

**加盐的好处：**

即使另一个用户 "Bob" 也用了 "123456" 作为密码，服务器会为 Bob 生成一个不同的盐（如 `abc123`）。因此，Alice 和 Bob 在数据库中存储的哈希值是完全不同的。这使得彩虹表彻底失效，因为黑客无法再预先计算哈希值了，他们必须针对每一个用户、每一个盐去独立计算，攻击成本大大增加。

---
