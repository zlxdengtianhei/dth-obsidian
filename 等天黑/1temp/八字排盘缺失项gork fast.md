# Bazi Paipan (排盘) 数据完整性审计报告

## 执行概述
- **依据**：后端排盘逻辑（`orchestrator_v3.py`、`bazi.py`、`paipan_storage.py`、`bazi_serializer.py`）。
- **当前排盘输出**（`paipan_result`，持久化到 `bazi_paipan_results` 表）：
  ```python
  {
    'pillars': {'year': [...], 'month': [...], 'day': [...], 'hour': [...]},  # 四柱
    'day_master': str,  # 日主
    'shishen': {...},  # 十神配置 (stems/branches)
    'nayin': {...},  # 纳音
    'shensha': [...],  # 神煞列表
    'canggan': {...},  # 藏干 (部分空)
    'kongwang': [...],  # 空亡 (部分空)
    'growth_stages': {...},  # 十二长生
    'wuxing_distribution': {...},  # 五行分布
    'yinyang_distribution': {...},  # 阴阳分布 (持久化)
    'siling': {...},  # 月令司令
    'wangshuai': {...},  # 旺衰 (王相衰囚)
    'dizhi_relations': {...},  # 地支关系 (六合/冲/刑/害，持久化)
    'shishen_count': {...},  # 十神数量统计 (持久化)
    'dayun': [...]  # 大运
  }
  ```
- **复用路径差异**：复用时从DB加载上述字段，但`canggan`/`kongwang`常空；未持久化：**胎元**/**命宫**/**小运**（无计算逻辑）。
- **审计原则**：逐书提取“排盘所需数据”（非解读数据），映射现有字段，批判缺失（**可计算未输出** vs **无逻辑**）。

## 逐书缺失项检查

### 1. 《三命通會》
**所需排盘数据**（从文档提取）：
- 四柱干支 ✅ (`pillars`)
- 日主五行属性 ✅ (`day_master`)
- 十二长生状态 ✅ (`growth_stages`)
- 十神配置 ✅ (`shishen`)
- 地支藏干 ✅ (`canggan`，但常空-**可计算**：`DIZHI_CANGAN`常量可用)
- 地支关系（六合/三合/冲/刑/害） ✅ (`dizhi_relations`)
- 神煞（禄/马/贵人/羊刃/空亡等） ✅ (`shensha`，但**kongwang**常空-**可计算**：旬空逻辑)
- 纳音五行 ✅ (`nayin`)
- 五行旺衰 ✅ (`wuxing_distribution` + `wangshuai`)
- 大运流年 ✅ (`dayun`，流年需动态)
- **胎元** ❌ (**无计算逻辑**：月柱纳音)
- **命宫** ❌ (**无计算逻辑**：年月日时纳音/局数)
- **性别** ✅ (输入参数，持久化)
- **出生地（阴阳昼夜）** ❌ (**无逻辑**：solar_time有昼夜可推，但未输出)

**缺失总结**：
| 缺失项 | 类型 | 批判 |
|--------|------|------|
| 胎元 | 无逻辑 | 文档强调胎元信息核心，缺此解读六亲/小儿命不全。**高优先补**。 |
| 命宫 | 无逻辑 | 影响格局/小运判断，文档多次提及。**高优先**。 |
| 地支藏干完整 | 可计算未持久 | 藏干是地支关系基础，常空导致复用失效。**中优先**：加`DIZHI_CANGAN`计算。 |
| 空亡完整 | 可计算未持久 | 神煞关键，缺影响判断准确性。**中优先**。 |
| 出生昼夜 | 可推未输出 | 文档“出生环境的阴阳”，solar_time可计算。**低优先**。

### 2. 《淵海子平》
**所需排盘数据**：
- 四柱 ✅
- 五行统计 ✅ (`wuxing_distribution`)
- 十神配置/数量 ✅ (`shishen` + `shishen_count`)
- 藏干 ✅ (部分)
- 大运流年 ✅
- 神煞/纳音 ✅
- **阴阳分布** ✅ (持久化，但文档强调基础)

**缺失总结**（参考`排盘补充/排盘缺失项补充说明.md`）：
| 缺失项 | 类型 | 批判 |
|--------|------|------|
| 阴阳分布 | 已持久但易忽略 | 文档“五行阴阳根本”，复用时需显式输出。**低优先**：序列化已支持。 |
| 地支关系 | 已持久 | 文档“合刑冲害”，完整。 |
| 十神数量 | 已持久 | 关键判断。 |
| **胎元/命宫** | 无逻辑 | 文档六亲/格局需，缺大问题。**高优先**。 |

**整体**：缺失少，主要补胎元/命宫。

### 3. 《滴天髓闡微》
**所需排盘数据**：
- 四柱 ✅
- 大运 ✅
- 流年 (动态)
- **地理位置** ❌ (输入longitude，但文档“原川之异”需明确输出影响调候)

**缺失总结**：
| 缺失项 | 类型 | 批判 |
|--------|------|------|
| 地理/地域分野 | 输入未结构化输出 | 文档强调“山川之异”，longitude仅计算solar_time，未用于“时地分野”。**中优先**：加地域五行影响计算。 |
| **胎元/命宫** | 无逻辑 | 格局/体用需。**高优先**。 |

**整体**：简单，缺地域细化。

### 4. 《窮通寶鑒》
**所需排盘数据**：
- 四柱 ✅
- 日主 ✅
- **月支旺衰** ✅ (`wangshuai`)
- **藏干** (部分)
- **天干透出** ✅ (`shishen`/pillars透干隐含)
- **节气深浅** (siling有days_elapsed ✅)

**缺失总结**：
| 缺失项 | 类型 | 批判 |
|--------|------|------|
| 藏干完整 | 可计算未持久 | 调候藏干核心，常空。**中优先**。 |
| **节气精确人元** | 已部分 (siling) | 文档“人元司令”，完整但需验证深浅。**低优先**。 |
| **胎元** | 无逻辑 | 影响小运/调候。**中优先**。

## 总体缺失汇总与批判
**高优先 (无计算逻辑)**：
- **胎元**：所有书均需 (三命/渊海强调小儿命/六亲)，当前无。**批判**：排盘不全，解读六亲/晚运失准。
- **命宫**：三命/渊海格局需。**批判**：缺此格局/小运盲区。

**中优先 (可计算未输出/持久)**：
- **完整藏干**：`DIZHI_CANGAN`常量直接用。**批判**：地支分析基础，所有书缺影响大。
- **完整空亡**：旬空算法简单。**批判**：神煞关键，三命/渊海多用。
- **地域五行/昼夜**：solar_time可推。**批判**：滴天/三命“时地分野”，缺个性化。

**低优先**：
- 阴阳/十神统计：已持久，显式输出即可。

**复用路径问题**：DB有大部分，但canggan/kongwang空；序列化`build_result_data`仅chart/time_report，未全paipan_result传维分析。**批判**：复用时维度分析易缺raw_data，导致RAG不准。

**补齐建议**：
1. bazi.py 加胎元/命宫/xiaoyun计算 (常量表+公式)。
2. paipan_storage.py 持久化完整canggan/kongwang/dizhi_relations。
3. orchestrator 复用时重建缺失字段。

**结论**：当前排盘**80%覆盖**，缺胎元/命宫/完整藏干/空亡为主要痛点。补齐后支持全书解读。