# Troupe 语言参考手册

## 内置表达式

### adv

**描述**: 模拟将值发送给级别为 `{}` 的对手。这是一个教学便利函数，避免在解释显式和隐式信息流时设置网络进程的必要性。
 **参数**: 要传递给对手的值。
 **返回**: Unit。
 **失败行为**: 如果提供的值和阻塞标签比底部更严格，则崩溃当前进程。
 **示例**: `adv(42 raisedTo '{alice}')`

### attenuate

**描述**: 返回衰减的权威。
 **参数**: 权威类型的值。
 **返回**: 权威类型的值。
 **示例**: `attenuate(authority, '{alice}')`

### authority

**描述**: 返回隐式提供给主程序顶级函数的权威参数。此参数的可访问性遵循标准词法作用域规则。
 **参数**: 无。

### declassify

**描述**: 对表达式进行降级。
 **参数**: 形式为 `(expr, authority, l)` 的三元组，其中 `expr` 是要降级的表达式，`authority` 是用于降级的权威，`l` 是降级的目标级别。
 **返回**: 如果有足够权威，则返回降级到目标级别的原始值。
 **失败行为**: 如果提供的权威不足以进行降级，则崩溃。
 **示例**:

```
let val x = 42 raisedTo '{alice}'
in print(declassify(x, authority, '{}'))
end
```

### exit

**描述**: 退出 Troupe 运行时。
 **参数**: 元组 `(authority, exitCode)`。
 **返回**: 无。
 **示例**: `exit(authority, 0)`

### getTime

**描述**: 获取当前 Unix 时间戳。
 **参数**: Unit。
 **返回**: Number。
 **示例**: `getTime()`

### inputLine

**描述**: 从控制台读取一行。
 **参数**: Unit。
 **返回**: String 值。
 **阻塞行为**: 同步。阻塞标签在此操作后提升到顶部，因为提供输入的用户被假定在顶级别操作。
 **注意**: 可以使用 `let pini` 结构降级阻塞标签，或使用 `stdio` 库中的 `inputLineWithPini` 和 `inputLineWithPini` 函数。

### lowermbox

**描述**: 降低当前进程邮箱的清除级别。
 **参数**: 提升能力和权威的元组。
 **返回**: Unit。
 **失败行为**: 如果参数类型无效（动态类型检查），权威不足，或提供的能力不匹配堆栈作用域规则，则失败。

### mkuuid

**描述**: 生成随机字符串。
 **参数**: Unit。
 **返回**: 新生成的字符串。
 **示例**: `print(mkuuid())`

### node

**描述**: 返回进程的节点标识符。
 **参数**: 进程标识符。
 **返回**: 包含节点标识符的字符串。

### pinipop

**描述**: 从 pini 堆栈弹出权威值，并降级当前阻塞级别。
 **参数**: 由 `pinipush` 生成的字符串。
 **返回**: Unit。
 **失败行为**: 如果弹出的权威不足以降级阻塞级别，或提供的能力与 `pinipush` 生成的最后一个能力不匹配，则崩溃。
 **示例**: `pinipop()`

### pinipush

**描述**: 将权威值推入 pini 堆栈。
 **参数**: 权威类型的值。
 **返回**: 字符串能力，用作 `pinipop` 的参数。
 **示例**: `pinipush(authority)`

### pinipushto

**描述**: 将权威值推入 pini 堆栈，带有显式阻塞级别。
 **参数**: 元组：权威类型的值和级别。
 **返回**: 字符串能力，用作 `pinipop` 的参数。
 **失败行为**: 如果当前阻塞级别不流向级别参数，则崩溃。
 **示例**: `pinipushto(authority, '{bob}')`

### print

**描述**: 在控制台打印值，省略其安全类型。
 **参数**: 任何类型的值。
 **返回**: Unit。
 **示例**: `print("Hello, world")`

### printWithLabels

**描述**: 在控制台打印值，包括其安全类型。
 **参数**: 任何类型的值。
 **返回**: Unit。
 **示例**: `printWithLabels("Hello, world")`

### raiseTrust

**描述**: 动态提高节点的信任级别。
 **参数**: 节点标识符、根级别权威和预期信任级别的三元组。
 **返回**: Unit。
 **失败行为**: 如果参数类型无效、权威参数不是顶级、或阻塞级别不是底级，则失败。
 **示例**: `raiseTrust("@alicescomputer", authority, '{alice}')`

### raisembox

**描述**: 提高当前进程邮箱的清除级别。
 **参数**: 安全级别。
 **返回**: 用于将邮箱级别降回先前值的能力。
 **失败行为**: 如果参数类型无效（动态类型检查），则失败。

### random

**描述**: 生成 0（含）到 1 之间的随机数。
 **参数**: Unit。
 **返回**: Number。
 **示例**: `random()`

### receive

**描述**: 从邮箱中选择消息。
 **参数**: 处理函数列表。
 **返回**: 匹配处理程序正文返回的值。
 **示例**:

```
receive [
  hn ("MESSAGE", x) => print(x),
  hn _ => print("Default handler")
]
```

### register

**描述**: 在名称下注册进程。
 **参数**: 形式为 `(str, pid, authority)` 的元组，其中 `str` 是进程要注册的名称，`pid` 是进程标识符，`authority` 是顶级权威值。
 **返回**: Unit。
 **阻塞行为**: 同步。
 **失败行为**: 如果提供的权威不是顶级，或阻塞级别不是底级，则崩溃。
 **示例**: `register("auctionServer", self(), authority)`

### rcv

**描述**: 从邮箱中选择消息，预先过滤消息的级别。
 **参数**: 形式为 `(hns, lo, hi)` 的三元组，其中 `hns` 是处理程序列表，`lo` 是消息发送者级别的下界，`hi` 是邮箱中消息发送者级别的上界。
 **返回**: 匹配处理程序正文返回的值。

### sandbox

**描述**: 在沙箱中执行函数，时间固定。
 **参数**: 形式为 `(t, f)` 的元组，其中 `t` 是超时时间（毫秒），`f` 是形式为 `fn() => e` 的函数，在沙箱中执行。
 **返回**: 形式为 `(ok, val)` 的元组，其中 `ok` 是 `true` 或 `false`，`true` 表示沙箱执行成功完成，`false` 表示沙箱出现崩溃或超时。
 **阻塞行为**: 同步。进程执行总是至少持续 `t` 时间。
 **失败行为**: 此函数始终成功，所有内部错误都被抑制。
 **示例**: `sandbox(1000, fn() => 1 + ())`

### self

**描述**: 返回当前进程标识符。
 **参数**: Unit。
 **返回**: 进程标识符类型的值。
 **示例**: `print(self())`

### send

**描述**: 向进程发送消息。
 **参数**: 形式为 `(pid, v)` 的元组，其中 `pid` 是接收进程的标识符，`v` 是要发送的值。
 **返回**: Unit。
 **失败行为**: 如果托管接收进程的节点不受信任接收 `v`，则崩溃当前进程。
 **阻塞行为**: 异步。
 **示例**: `send(pid, "Hello")`

### _setProcessDebuggingName

**描述**: 设置用于调试的进程名称。
 **参数**: 字符串值。
 **返回**: Unit。
 **失败行为**: 如果参数类型无效（动态类型检查），则失败。

### sleep

**描述**: 暂停当前线程的执行指定时间。
 **参数**: 一个数字类型参数，指定睡眠时间（毫秒）。
 **返回**: Unit。
 **示例**: `sleep(100)`

### spawn

**描述**: 在本地或远程创建新进程。
 **参数**: 形式为 `(nodeid, f)` 的元组（`nodeid` 是节点标识符字符串）和函数，或一个函数类型参数。函数必须是形式为 `fn() => e` 的形式。
 **返回**: 新创建进程的标识符。
 **阻塞行为**: 阻塞直到新进程创建。
 **示例**: `print(self(), spawn(fn() => print(self())))`

### raisedTo

**描述**: 提高值的级别。使用中缀语法。
 **参数**: 任何类型的表达式和一个级别。
 **返回**: 级别提高到提供级别的相同表达式。
 **示例**: `42 raisedTo '{alice}'`

### whereis

**描述**: 在远程节点上查找已注册的进程。
 **参数**: 形式为 `(nodeid, name)` 的元组，其中 `nodeid` 是表示节点 p2p 标识符的字符串，`name` 是在该节点注册的进程名称。
 **返回**: 远程机器上节点的进程标识符。
 **阻塞行为**: 同步。
 **失败行为**: 如果程序计数器级别和名称级别不流向节点的信任级别，则崩溃。
 **示例**:

```
let val p = whereis(
  "QmeuSjy8RbeUHpqtDGj2B66fPHxRowuoecZnaVkvhTS7tb",
  "auctionServer")
in send(p, ("BID", 42))
end
```

## 有用的标准库

### declassifyutil 库

包含用于元组深度降级和同时降级表达式和阻塞级别的实用函数。

**declassify_with_block(v, auth, lev)**: 接受三个参数——要降级的值、权威和目标级别，同时降级阻塞标签和值。

**declassify_deep(v, auth, lev)**: 与上面类似，但额外进一步降级嵌套列表和最多九个元素的元组。

### lists 库

包含标准列表函数，如 `map`、`mapi`、`foldi`、`range`、`reverse`、`lookup`、`elem`、`length`、`append` 和 `partition`。

## 操作技巧

1. 使用 `declassifyutil` 库中的 `declassify_with_block` 和 `declassify_deep` 简化复杂的降级操作
2. 使用 `_setProcessDebuggingName` 为进程设置有意义的调试名称
3. 合理使用沙箱 (`sandbox`) 执行不受信任的代码
4. 使用 `pini` 相关函数管理阻塞标签
5. 利用 `lists` 库中的函数简化列表操作

## 常见模式

1. **安全输入处理**：使用 `let pini` 或 `stdin` 库函数处理输入
2. **权威委托**：使用 `attenuate` 减弱权威后再传递给其他模块
3. **消息过滤**：使用 `rcv` 根据发送者的安全级别过滤消息
4. **沙箱执行**：使用 `sandbox` 安全地执行不受信任的代码
5. **进程注册**：使用 `register` 和 `whereis` 实现分布式服务发现

通过理解和使用这些内置表达式和库，您可以充分利用 Troupe 语言的信息流控制和并发特性构建安全的分布式应用程序。